@page
@model SM.APP.Pages.Events.EventStatisticsModel
@{
    ViewData["Title"] = "Event Statistics";
}
<div class="container my-4">
    <h2 class="mb-4">Event Statistics</h2>
    <input type="hidden" name="eventID" value="@ViewContext.HttpContext.Request.Query["eventID"]" />

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">Filter by Status</h6>
            <div class="btn-group w-100" role="group" aria-label="Status Filter">
                <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="All" checked autocomplete="off">
                <label class="btn btn-outline-primary" for="filterAll">All</label>

                <input type="radio" class="btn-check" name="statusFilter" id="filterPresent" value="Present" autocomplete="off">
                <label class="btn btn-outline-success" for="filterPresent">Present</label>

                <input type="radio" class="btn-check" name="statusFilter" id="filterAbsent" value="Absent" autocomplete="off">
                <label class="btn btn-outline-danger" for="filterAbsent">Absent</label>
            </div>
        </div>
    </div>

    <div class="row g-4">

        <div class="col-12 col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-people-fill me-2"></i>Teams</h5>
                    <span class="badge bg-light text-primary" id="totalTeamsCount">0</span>
                </div>
                <div class="card-body p-0">
                    <div class="accordion accordion-flush" id="accordionTeams">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12 col-lg-6">
            <div class="card h-100 border-0 shadow-sm">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-bus-front-fill me-2"></i>Buses</h5>
                    <span class="badge bg-dark text-warning" id="totalBusesCount">0</span>
                </div>
                <div class="card-body p-0">
                    <div class="accordion accordion-flush" id="accordionBuses">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var apiBaseUrl = '@Services.SMConfigurationManager.ApiBase';

        // Store all members globally to avoid re-fetching on filter change
        let allMembersData = [];

        document.addEventListener('DOMContentLoaded', function () {
            // Initial Fetch
            fetchEventAttendedMembers();

            // Attach Filter Event Listeners
            document.querySelectorAll('input[name="statusFilter"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    applyFilter(e.target.value);
                });
            });
        });

        async function fetchEventAttendedMembers() {
            const url = `${apiBaseUrl}/Events/GetEventMembers`;
            const eventID = document.querySelector('input[name="eventID"]').value;

            if (!eventID) {
                console.error("Event ID is missing");
                alert("Event ID is missing.");
                return;
            }

            try {
                // Fetching ALL relevant members first, then we filter client side
                // Assuming 'registered=true' fetches the base list.
                // If you need absolutely everyone (including non-registered but attended), adjust params.
                const response = await fetch(`${url}?eventID=${eventID}&registered=true`, {
                    method: "GET",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" }
                });

                if (!response.ok) {
                    console.error("HTTP Error");
                    return;
                }

                allMembersData = await response.json();

                // Initial render with "All"
                applyFilter("All");

            } catch (error) {
                console.error("Network error:", error);
            }
        }

        function applyFilter(filterType) {
            let filteredMembers = [];

            switch (filterType) {
                case "Registered":
                    filteredMembers = allMembersData.filter(m => m.registered === true);
                    break;
                case "Present":
                    filteredMembers = allMembersData.filter(m => m.attended === true);
                    break;
                case "Absent":
                    // Note: Depending on your logic, absent might mean (Registered == true AND Attended != true)
                    filteredMembers = allMembersData.filter(m => !m.attended);
                    break;
                case "All":
                default:
                    filteredMembers = [...allMembersData];
                    break;
            }

            populateTable(filteredMembers);
        }

        function populateTable(members) {
            renderTeamStats(members);
            renderBusStats(members);
        }

        // ---------------------------------------------------------
        // LOGIC: Team Statistics
        // ---------------------------------------------------------
        function renderTeamStats(members) {
            const container = document.getElementById('accordionTeams');
            container.innerHTML = '';

            // Group by Team
            const teamGroups = {};

            members.forEach(m => {
                const teamName = m.team || "No Team"; // Handle nulls
                if (!teamGroups[teamName]) {
                    teamGroups[teamName] = {
                        count: 0,
                        years: {},
                        genders: { 'M': 0, 'F': 0, 'Other': 0 }
                    };
                }

                // 1. Total Count
                teamGroups[teamName].count++;

                // 2. Birth Year Count
                if (m.birthdate) {
                    const year = new Date(m.birthdate).getFullYear();
                    teamGroups[teamName].years[year] = (teamGroups[teamName].years[year] || 0) + 1;
                }

                // 3. Gender Count
                const gender = m.gender || 'Other'; // Assuming char 'M'/'F' comes from API
                if(teamGroups[teamName].genders[gender] !== undefined) {
                    teamGroups[teamName].genders[gender]++;
                } else {
                    teamGroups[teamName].genders['Other'] = (teamGroups[teamName].genders['Other'] || 0) + 1;
                }
            });

            // Update Badge
            document.getElementById('totalTeamsCount').innerText = Object.keys(teamGroups).length;

            // Render HTML
            let index = 0;
            for (const [teamName, stats] of Object.entries(teamGroups)) {
                index++;
                const collapseId = `collapseTeam${index}`;

                // Sort years for display
                const sortedYears = Object.entries(stats.years).sort((a, b) => b[0] - a[0]); // Descending

                let yearsHtml = sortedYears.map(([year, count]) =>
                    `<li class="list-group-item d-flex justify-content-between align-items-center py-1">
                        ${year}
                        <span class="badge bg-secondary rounded-pill">${count}</span>
                    </li>`
                ).join('');

                const html = `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <div class="d-flex justify-content-between w-100 me-3">
                                <span class="fw-bold">${teamName}</span>
                                <span class="badge bg-primary rounded-pill">${stats.count} Members</span>
                            </div>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#accordionTeams">
                        <div class="accordion-body bg-light">
                            <h6 class="text-muted border-bottom pb-1">Gender Breakdown</h6>
                            <div class="d-flex justify-content-around mb-3">
                                <span class="text-primary"><i class="bi bi-gender-male"></i> Male: <strong>${stats.genders['M'] || 0}</strong></span>
                                <span class="text-danger"><i class="bi bi-gender-female"></i> Female: <strong>${stats.genders['F'] || 0}</strong></span>
                            </div>

                            <h6 class="text-muted border-bottom pb-1">Birth Year Breakdown</h6>
                            <ul class="list-group list-group-flush small">
                                ${yearsHtml || '<li class="list-group-item text-muted">No birthdates available</li>'}
                            </ul>
                        </div>
                    </div>
                </div>`;

                container.innerHTML += html;
            }

            if (Object.keys(teamGroups).length === 0) {
                container.innerHTML = '<div class="p-3 text-center text-muted">No teams found for this filter.</div>';
            }
        }

        // ---------------------------------------------------------
        // LOGIC: Bus Statistics
        // ---------------------------------------------------------
        function renderBusStats(members) {
            const container = document.getElementById('accordionBuses');
            container.innerHTML = '';

            // Group by Bus
            const busGroups = {};

            members.forEach(m => {
                const busName = m.bus || "No Bus Assigned";
                const teamName = m.team || "No Team";

                if (!busGroups[busName]) {
                    busGroups[busName] = {
                        count: 0,
                        teams: {}
                    };
                }

                // 1. Total Bus Count
                busGroups[busName].count++;

                // 2. Team Breakdown within Bus
                busGroups[busName].teams[teamName] = (busGroups[busName].teams[teamName] || 0) + 1;
            });

            // Update Badge
            document.getElementById('totalBusesCount').innerText = Object.keys(busGroups).length;

            // Render HTML
            let index = 0;
            for (const [busName, stats] of Object.entries(busGroups)) {
                index++;
                const collapseId = `collapseBus${index}`;

                // Sort teams for display
                const sortedTeams = Object.entries(stats.teams).sort((a, b) => b[1] - a[1]); // Sort by count descending

                let teamsHtml = sortedTeams.map(([team, count]) =>
                    `<li class="list-group-item d-flex justify-content-between align-items-center py-1">
                        ${team}
                        <span class="badge bg-secondary rounded-pill">${count}</span>
                    </li>`
                ).join('');

                const html = `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <div class="d-flex justify-content-between w-100 me-3">
                                <span class="fw-bold">${busName}</span>
                                <span class="badge bg-warning text-dark rounded-pill">${stats.count} Members</span>
                            </div>
                        </button>
                    </h2>
                    <div id="${collapseId}" class="accordion-collapse collapse" data-bs-parent="#accordionBuses">
                        <div class="accordion-body bg-light">
                            <h6 class="text-muted border-bottom pb-1">Team Distribution</h6>
                            <ul class="list-group list-group-flush small">
                                ${teamsHtml}
                            </ul>
                        </div>
                    </div>
                </div>`;

                container.innerHTML += html;
            }

            if (Object.keys(busGroups).length === 0) {
                container.innerHTML = '<div class="p-3 text-center text-muted">No buses found for this filter.</div>';
            }
        }
    </script>
}